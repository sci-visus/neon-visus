<!DOCTYPE html>
<script>
/*
 * Copyright (c) 2019 University of Utah 
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the copyright holder nor the names of its
 *    contributors may be used to endorse or promote products derived from
 *    this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */
</script>

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <title>ViSUS WebViewer</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">-->
  <!--<link rel="stylesheet" href="https://bootswatch.com/3/paper/bootstrap.min.css">-->
  <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> -->

  <link rel="stylesheet" href="bootstrap.min.flatly.css">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/css/bootstrap-select.min.css" />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js" integrity="sha256-DI6NdAhhFRnO2k51mumYeDShet3I8AKCQf/tf7ARNhI=" crossorigin="anonymous"></script> 

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>

  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>

<style type="text/css">
body{
  background: #f3f5f5;
  fontFamily: '"Source Sans Pro",Helvetica,Arial,sans-serif';
  fontWeightLight: 200;
  fontWeightRegular: 400;
  fontWeightMedium: 600;
  fontWeightBold: 700;
}
h1: {
  fontWeight: 200,
  fontSize: '4.125rem',
}
h2: {
  fontWeight: 200,
  fontSize: '3.5rem',
}
h3: {
  fontWeight: 400,
  fontSize: '2.75rem',
}
h4: {
  fontWeight: 400,
  fontSize: '2.125rem',
}
h5: {
  fontWeight: 600,
  fontSize: '1.5rem',
}
h6: {
  fontWeight: 700,
  fontSize: '1.15rem',
}

* { margin:0; padding:0; } /* to remove the top and left whitespace */

html, body { width:100%; height:100%; } /* just to be sure these are full screen*/

canvas { display:block; } /* To remove the scrollbars */

.slidecontainer {
  width: 100%; /* Width of the outside container */
}

.slider {
  -webkit-appearance: none;
  width: 100%;
  height: 15px;
  border-radius: 5px;   
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
  display: table-cell;
  vertical-align: middle;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 25px;
  height: 25px;
  border-radius: 50%; 
  background: #4CAF50;
  cursor: pointer;
  vertical-align: middle;
}

.slider::-moz-range-thumb {
  width: 25px;
  height: 25px;
  border-radius: 50%;
  background: #4CAF50;
  cursor: pointer;
  vertical-align: middle;
}

/*
.nav>li{
  padding-right: 10px;
  padding-left: 10px;
}*/

/* Style page content */
.main {
  margin-left: 160px; /* Same as the width of the sidebar */
  padding: 0px 10px;
}

/* On smaller screens, where height is less than 450px, change the style of the sidebar (less padding and a smaller font size) */
@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}

#body-row {
    margin-left:0;
    margin-right:0;
}

#sidebar-container {
    /*min-height: 100vh;
    background-color: #f3f5f5;*/
    padding: 0;
    position:absolute;
    right: 0%;
    top:0%;
    z-index:2;
    /*float: right;*/

}

/* Sidebar sizes when expanded and expanded */
.sidebar-expanded {
    width: 250px;
}
.sidebar-collapsed {
    width: 60px;
}

/* Menu item*/
#sidebar-container .list-group a {
    height: 50px;
    color: black;
}

/* Submenu item*/
#sidebar-container .list-group .sidebar-submenu a {
    height: 45px;
    padding-left: 30px;
}
.sidebar-submenu {
    font-size: 0.9rem;
}

/* Separators */
.sidebar-separator-title {
    background-color: #f3f5f5;
    height: 35px;
}
.sidebar-separator {
    background-color: #f3f5f5;
    height: 25px;
}
.logo-separator {
    background-color: #f3f5f5;    
    height: 60px;
}

/* Closed submenu icon */
#sidebar-container .list-group .list-group-item[aria-expanded="false"] .submenu-icon::after {
  content: " \f0d7";
  font-family: FontAwesome;
  display: inline;
  text-align: right;
  padding-left: 10px;
}
/* Opened submenu icon */
#sidebar-container .list-group .list-group-item[aria-expanded="true"] .submenu-icon::after {
  content: " \f0da";
  font-family: FontAwesome;
  display: inline;
  text-align: right;
  padding-left: 10px;
}

a.bg-light.list-group-item.list-group-item-action.flex-column.align-items-start {
    padding-left: 2.1em;
}

small {
  color: black;
  font-size: 8pt;
}

.navbar {
  padding:0;
}

</style>

</head>
  
<body>
  <nav class="navbar navbar-expand-sm navbar-light bg-light fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand order-md-last" href="https://www.visus.org" target="blank"><small>powered by OpenVisus<img src='visus.org-logo.png 'width="50"/></small></a>
      <div class="navbar-header">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navbar" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
      <div class="collapse navbar-collapse" id="main-navbar">
        <ul class="navbar-nav mr-auto">

            
          
            <li style="padding-left: 5px">
              <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#downloadModal" onclick="setDefaultResolution()"><span class="fa fa-download"></span>&nbsp;&nbsp;Download</button>
              <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#shareModal" onclick="shareLink()" hidden><span class="fa fa-external-link-alt"></span>&nbsp;&nbsp;Share</button>
            </li>

        </ul>
        <ul class="nav navbar-nav navbar-logo mr-auto">
          <li class="nav-item">
            <small id="titlelbl" class="nav-link" href="#"><b></b></small>
          </li>
        </ul>

      </div>
    </div>
  </nav>

  <nav class="navbar navbar-expand-sm navbar-light bg-light fixed-bottom">
    <div class="container-fluid">
      <div class="collapse navbar-collapse" id="control-navbar">
        <ul class="navbar-nav mr-auto">
          <li id="field_controls">
              <div class="input-group input-group-sm">
                <div class="input-group-prepend">
                  <span class="input-group-text form-control-sm">Field</span>
                </div>
                <div class="input-group-append input-group-sm">
                  <select id='field' onchange='onFieldChange(this.value);' class='form-control form-control-sm'></select> 
                </div>
              </div>
            </li>
            <li style="padding-left: 5px" id="colormap_controls">
              <!-- <button id="palettebtn" class="btn btn-warning btn-sm navbar-btn"><span class="fa fa-palette"></span></button> -->
              <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                      <span class="input-group-text form-control-sm">Colormap</span>
                    </div>
                    <div class="input-group-append input-group-sm">
                      <select id='palette' onchange='onPaletteChange();' class='custom-select'>
                        <option value='' selected="selected"></option>
                        <option value='rich'>rich</option>
                        <option value='hsl'>hsl</option>
                        <option value='banded'>banded</option>
                        <option value='bry'>bry</option>
                        <option value='bgry'>bgry</option> 
                        <option value='gamma'>gamma</option>
                        <option value='hot1'>hot1</option>
                        <option value='hot2'>hot2</option>
                        <option value='ice'>ice</option>
                        <option value='lighthues'>lighthues</option> 
                        <option value='smoothrich'>smoothrich</option>
                        <option value='lut16'>lut16</option>
                        <option value='BlueGreenDivergent'>BlueGreenDivergent</option>
                        <option value='AsymmetricBlueGreenDivergent'>AsymmetricBlueGreenDivergent</option> 
                        <option value='GreenGold'>GreenGold</option>
                        <option value='LinearGreen'>LinearGreen</option>
                        <option value='LinearTurquois'>LinearTurquois</option>
                        <option value='MutedBlueGreen'>MutedBlueGreen</option>
                        <option value='ExtendedCoolWarm'>ExtendedCoolWarm</option>
                        <option value='AsymmetricBlueOrangeDivergent'>AsymmetricBlueOrangeDivergent</option>
                        <option value='LinearYellow'>LinearYellow</option>
                        <option value='LinearGray5'>LinearGray5</option>
                        <option value='LinearGray4'>LinearGray4</option>  
                        <option value='grayopaque'>grayopaque</option>
                        <option value='graytransparent'>graytransparent</option> 
                      </select>
                    </div>
                  </div>
            </li>
            <li style="padding-left: 5px" id="range_controls">
              <div class="input-group input-group-sm">
                  <div class="input-group-prepend">
                    <span class="input-group-text form-control-sm">Range</span>
                  </div>
                  <div class="input-group-append">
                    <input id='palette_min' type="text" size=8 onchange='onPaletteChange();' class="form-control form-control-sm" placeholder="Min">
                  </div>
                  <div class="input-group-append">
                    <input id='palette_max' type="text" size=8 onchange='onPaletteChange();' class="form-control form-control-sm" placeholder="Max">
                  </div>

                </div>
              </li>
        </ul>
      </div>
    </div>

  </nav>

  <div class="container" hidden>

      <div id="sidebar-container" class="sidebar-expanded d-none d-md-block">
      <!-- d-* hiddens the Sidebar in smaller devices. Its itens can be kept on the Navbar 'Menu' -->
            <!-- Bootstrap List Group -->
        <ul class="list-group">
          <!-- Logo -->
            <li class="list-group-item logo-separator d-flex justify-content-center">
              <div class="row">
                <div class="col" style="margin-left: 60px;">
                  <img src='neon-logo.png' width="60" class="menu-collapsed"/> 
                </div>
                <div class="col" style="text-align: left">
                  <button type="button" data-toggle="sidebar-colapse" class="btn btn-sm">
                      <div class="d-flex w-100 justify-content-start align-items-center">
                        <span id="collapse-text" class="menu-collapsed text-muted"></span>
                        <span id="collapse-icon" class="fa fa-2x mr-3 text-muted"></span>
                      </div>
                  </button>
                </div>
                
              </div>
            </li>   
            
            <!-- /END Separator -->
            <!-- Menu with submenu -->
            <!-- <a href="#submenu1" data-toggle="collapse" aria-expanded="false" class="bg-light list-group-item list-group-item-action flex-column align-items-start">
                <div class="d-flex w-100 justify-content-start align-items-center">
                    <span class="fa fa-database fa-fw mr-3"></span> 
                    <span class="menu-collapsed">Field</span>
                    <span class="submenu-icon ml-auto"></span>
                </div>
            </a> -->
            <!-- hiding advanced settings -->
            <div hidden>

            <!-- <li class="list-group-item sidebar-separator-title text-muted d-flex align-items-center menu-collapsed"> 
                <small><span class="fa fa-database fa-fw mr-3"></span> Field</small>
            </li>
             
            <li class="list-group-item text-muted align-items-center menu-collapsed"> 
                <div class="input-group input-group-sm">
                  <div class="input-group-prepend">
                    <span class="input-group-text form-control-sm">Field</span>
                  </div>
                   <div class="input-group-append input-group-sm" style="width:100%" >
                     <select id='field' onchange='onFieldChange(this.value);' class='custom-select'></select> 
                   </div>
                 </div>
                    
            </li> -->

            <li class="list-group-item sidebar-separator-title text-muted d-flex align-items-center menu-collapsed"> 
                <small><span class="fa fa-palette fa-fw mr-3"></span> Palette</small>
            </li>

            <!-- Submenu content -->
            <li class="list-group-item text-muted align-items-center menu-collapsed"> 
              <!-- <br />
                <div class="input-group input-group-sm"> -->
                  <!-- <div class="input-group-prepend">
                    <span class="input-group-text form-control-sm">Color</span>
                  </div> -->
                 <!--  <div class="input-group-append input-group-sm">
                    <select id='palette' onchange='onPaletteChange();' class='custom-select'>
                      <option value='NaN' selected="selected"></option>
                      <option value='rich'>rich</option>
                      <option value='hsl'>hsl</option>
                      <option value='banded'>banded</option>
                      <option value='bry'>bry</option>
                      <option value='bgry'>bgry</option> 
                      <option value='gamma'>gamma</option>
                      <option value='hot1'>hot1</option>
                      <option value='hot2'>hot2</option>
                      <option value='ice'>ice</option>
                      <option value='lighthues'>lighthues</option> 
                      <option value='smoothrich'>smoothrich</option>
                      <option value='lut16'>lut16</option>
                      <option value='BlueGreenDivergent'>BlueGreenDivergent</option>
                      <option value='AsymmetricBlueGreenDivergent'>AsymmetricBlueGreenDivergent</option> 
                      <option value='GreenGold'>GreenGold</option>
                      <option value='LinearGreen'>LinearGreen</option>
                      <option value='LinearTurquois'>LinearTurquois</option>
                      <option value='MutedBlueGreen'>MutedBlueGreen</option>
                      <option value='ExtendedCoolWarm'>ExtendedCoolWarm</option>
                      <option value='AsymmetricBlueOrangeDivergent'>AsymmetricBlueOrangeDivergent</option>
                      <option value='LinearYellow'>LinearYellow</option>
                      <option value='LinearGray5'>LinearGray5</option>
                      <option value='LinearGray4'>LinearGray4</option>  
                      <option value='grayopaque'>grayopaque</option>
                      <option value='graytransparent'>graytransparent</option> 
                      <option value='scivis_magic_colormap'>magic color map</option>
                    </select>
                  </div>
                 </div> 
              <br />
               <div class="input-group input-group-sm" >
                  <div class="input-group-prepend">
                    <span class="input-group-text form-control-sm">Range</span>
                  </div>
                    <div class="form-group input-group-append col-xs-6" style="width:40%">
                      <input id='palette_min' type="text" size=7 onchange='onPaletteChange();' class="form-control form-control-sm" placeholder="Min"/>
                    </div>
                    <div class="form-group input-group-append col-xs-6" style="width:35%">
                      <input id='palette_max' type="text" size=7 onchange='onPaletteChange();' class="form-control form-control-sm" placeholder="Max"/>
                    </div>
                </div>  -->
            </li>            
           <!--  <a href="#" class="bg-light list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-start align-items-center">
                    <span class="fa fa-tasks fa-fw mr-3"></span>
                    <span class="menu-collapsed">Tasks</span>    
                </div>
            </a> -->

            <li class="list-group-item sidebar-separator-title text-muted d-flex align-items-center menu-collapsed"> 
                <small><span class="fa fa-clock fa-fw mr-3"></span> Time</small>
            </li>
            <!-- Submenu content -->
            <li class="list-group-item text-muted align-items-center menu-collapsed"> 
              <div class="input-group input-group-sm" >
                <div class="input-group-prepend">
                  <span class="input-group-text form-control-sm">Time</span>
                </div>
                <div class="input-group-append col-xs-6" style="width:53%">
                  <input class="slider form-control-sm navbar-btn" style="margin-top:8px" id='time' type='range' step='1' oninput="onTimeChange(this.value);" onchange="onTimeChange(this.value);"/> 
                </div>
                <div class="input-group-append col-xs-6">
                  <input id='edit_time' size=4 onchange='onTimeChange(this.value);' class='form-control form-control-sm navbar-btn' style="margin-top: 0px;"/>
                </div>
              </div>
            </li>
          </div>

            <li class="list-group-item sidebar-separator-title text-muted d-flex align-items-center menu-collapsed"> 
                <small><span class="fa fa-download fa-fw mr-3"></span> Download & Share</small>
            </li>

<!--             <li class="list-group-item text-muted align-items-center menu-collapsed" >
                 <button type="button" class="btn btn-primary" style="width:49%" data-toggle="modal" data-target="#downloadModal" onclick="setDefaultResolution()">Download</button>
                    <button type="button" class="btn btn-info" style="width:49%" data-toggle="modal" id='download_btn' data-target="#shareModal" onclick="shareLink()">Share</button> 
            </li>

            
            <li class="list-group-item sidebar-separator-title text-muted d-flex align-items-center menu-collapsed" > 
                <small style="margin-left: 10px;">powered by <a href="https://www.visus.org">OpenVisus &nbsp;&nbsp;&nbsp;<img src='visus.org-logo.png 'width="50"/> </a></small>
            </li>
 -->
            <!-- Separator with title -->
            
            
        </ul><!-- List Group END-->
    </div><!-- sidebar-container END -->
  
  </div>

  <div id="viewer">
    <div class="container">
      <div class="row row-centered pos">
        <div id='2dCanvas' style='background-color: black; width:100%;height:85vh;position: absolute;left:0px;margin-top:40px'></div>
        <div class="col-lg h-100"><canvas id='3dCanvas' width='1000px' height='600px'></canvas></div>
      </div>
    </div>
  </div>

<script>

  $('#palettebtn').click(function() {
      // reset modal if it isn't visible
      if (!($('.modal.in').length)) {
        $('#palette-modal-dialog').css({
          top: 0,
          left: $('#palettebtn').position().left-50
        });
      }

      $('#paletteModal').modal({
        backdrop: false,
        show: true
      });

      $('#palette-modal-dialog').draggable({
        handle: ".modal-body"
      });
    });

  var selection_box= new Array();
  // Selection widget
  var selection;

  // Hide submenus
  $('#body-row .collapse').collapse('hide'); 

  // Collapse/Expand icon
  $('#collapse-icon').addClass('fa-angle-double-right'); 

  // Collapse click
  $('[data-toggle=sidebar-colapse]').click(function() {
      SidebarCollapse();
  });

  function SidebarCollapse () {
      $('.menu-collapsed').toggleClass('d-none');
      $('.sidebar-submenu').toggleClass('d-none');
      $('.submenu-icon').toggleClass('d-none');
      $('#sidebar-container').toggleClass('sidebar-expanded sidebar-collapsed');
      
      // Treating d-flex/d-none on separators with title
      var SeparatorTitle = $('.sidebar-separator-title');
      if ( SeparatorTitle.hasClass('d-flex') ) {
          SeparatorTitle.removeClass('d-flex');
      } else {
          SeparatorTitle.addClass('d-flex');
      }
      
      // Collapse/Expand icon
      $('#collapse-icon').toggleClass('fa-angle-double-right fa-angle-double-left');
  }

</script>

<body>

      <div id="downloadModal" class="modal fade modal-fullscreen" role="dialog">
              <div class="modal-dialog">

            <!-- Download Modal content-->
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Select a resolution to download</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              
              <div class="modal-body">
                <div class="col" style="padding:20px">
                  <div class="row-md-6 text-center">
                    <div class="slidecontainer">
                      <input  id='resolution' type='range' step='1' min='0' step='1' max='33' class="slider form-control-sm navbar-btn" oninput='updateDownloadResolution(this.value);'/> 
                    </div>
                  </div>
                  <div class="row-md-6 text-center">
                    <label style="color:green">Resolution:&nbsp;</label><label style="color:green" id='res_lbl'>&nbsp;</label>
                  </div>
                  <div class="row-md-6 text-center">
                    <label>Size:&nbsp;</label><label id="size_est" > ... KB </label>
                  </div>
                  <div class="alert alert-warning" role="alert" id="download_alert" hidden>
                    It is currently not allowed to download large amount of data from here.
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button class="btn btn-primary" id='download_btn' glyphicon="glyphicon-ok" onclick='callDownload()'>Download</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
            </div>

          </div>
        </div>

        <div id="shareModal" class="modal fade fullscreen" role="dialog">
          <div class="modal-dialog">
            <!-- Share Modal content-->
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Share Link</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              
              <div class="modal-body">
              <div class="col" style="padding:20px">
                <div class="input-group">
                <input type="text" id='link_text' class="form-control"
                    value="/path/to/foo/bar" placeholder="Some path">
                  <span class="input-group-btn">
                    <button class="btn btn-default" type="button" id="copy-button"
                        data-toggle="tooltip" data-placement="button"
                        title="Copy to Clipboard" onclick="copyClick()">
                      Copy
                    </button>
                  </span>
                </div>
                <!-- <input id='link_text' style='width:100%' />  -->
                 </div>
              </div>
              <div class="modal-footer">
                <!-- <button id="copy_btn" class="btn btn-primary" onclick='onCopy()' glyphicon="glyphicon-ok">Copy</button> -->
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

        <div id="paletteModal" class="modal fade myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div id="palette-modal-dialog" class="modal-dialog my-modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body">
                  

                  <div id='resolution_panel' class="input-group input-group-sm" style="padding-top:5px">
                    <div class="input-group-prepend">
                      <span class="input-group-text">Resol.</span>
                    </div>
                    <div class="input-group-append">
                      <input id='edit_resolution' type="text" size="2" onchange='onResolutionChange(this.value);'/>
                    </div>
                    <div class="input-group-append">
                      <div class="input-group-text">
                        <input id='resolutionview' type='range' step='1' min='0' step='1' max='33' class="custom-range" oninput='onResolutionChange(this.value);'/> 
                      </div>
                    </div>
                    <!-- <div class="input-group-append">
                      <label class="input-group-text" id="size_est"> ... KB </label>
                    </div> -->
                    <div class="input-group-append">
                      <button id='view_btn' type='button' class="btn btn-primary btn-sm" onclick='onViewResolution()'>Update</button> 
                    </div>
                  </div>
                  
              </div>

              <div class="modal-footer">
                <div id="range_panel" style="color:white; padding-bottom:5px">
                    <span class="form-control-sm">Computed Range <span class="form-control-sm" id="comp_range"> [...] </span></span>
                </div>
                <button type="button" class="btn btn-danger btn-sm" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div> 
  
      
      <table hidden> 
     
        <tr id='row_link' hidden></tr>
        <tr hidden>
          <td>
            <div class="datagrid">
              <table width='100%'>
                <tr>
                  <td disabled> <label>Server</label> <input id='server' size=32 onchange='setServer(this.value);' class='toolbar_value'/>
                  <td hidden> <label>Render</label> 
                    <select id='render_type' onchange='onVRChange(this.value);' class='toolbar_value'>
                      <option value="0">Slice</option>
                      <option value="1">Volume</option>
                      <option value="2">Iso Contour</option>
                    </select>
                  <td> <label>Dataset</label> <select id='dataset' onchange='setDataset(this.value);' class='toolbar_value' disabled/>
                  
                  <td hidden><input id='auto_refresh' type='checkbox' size=32 onchange='onRefreshChange(this.value);' class='toolbar_value'>auto</input> <input type='button' value='Refresh' onclick="refreshAll(0)"/> </td>
                  <td id='range_panel'><label>Range</label> <label id="comp_range"> [...] </label>
                  <td id='resolution_panel'><label>Resolution</label>
                    
                  <td id='edit_resolution_panel' ><div><input id='edit_resolution' size=2 onchange='onResolutionChange(this.value);' class='toolbar_value'/><label id="size_est"> ... KB </label>
                  
                </div>
                  <td><div><input id='view_btn' type='button' value='View' onclick='onViewResolution()' hidden/>  <input type='button' value='Share' onclick='shareLink()'/></div>
                </tr>
              </table>
            </div>
          </td>   
        </tr>    
        <tr hidden>
          <td>
            <div class="datagrid">
              <table width='100%' >
                <tr>
                  <td hidden><label id="axis_label">Axis</label>
                  <td hidden>
                    <select id='axis' onchange='onAxisChange(this.value);' class='toolbar_value'>
                      <option value='2'>Z</option>
                      <option value='1'>Y</option>
                      <option value='0'>X</option>
                    </select>
                    
                  <td hidden><label id='render_slider_lbl'>Slice</label>
                  <td width='50%' hidden>
                    <table width='100%'>
                      <tr width='100%'>
                        <td width='100%'>
                          <input id='slice' type='range' min='0' step='1' max='100' style='width:100%' oninput='onSliceChange(this.value);'/>
                        <td>
                          <input id='edit_slice' size=2 onchange='onSliceChange(this.value);' class='toolbar_value'>
                      </tr>
                    </table>
                  
                </tr>
              </table>
            </div>
          </td>
        </tr>
      </table>

  <!-- <details ontoggle="load_dataset(this, &#39;aneurism&#39;, {level: 24, width: 256, height: 256, depth: 256}, &#39;uint8&#39;, {width: 256.0, height: 256.0, depth: 256.0})"/> -->

  </div>
</div>

  <script src='https://openseadragon.github.io/openseadragon/openseadragon.min.js'></script>
  <script src="visus/src/selection/openseadragonselection.js"></script>
  <script src="visus/src/colormaps.js"></script>
  <script src="visus/src/dvr.js"></script>
  <script src="visus/src/visus.js"></script>
  <script src="visus/config.js"></script> 
  <script src="visus/src/viewer.js"></script>
  <script>
    

    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = window.location.search.substring(1),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
            }
        }
    };

    function rectToSelection(bounds){
      rect=visus1.osd.viewport.viewportToImageRectangle(bounds.x, bounds.y, bounds.width, bounds.height)
      rect=new OpenSeadragon.Rect(Math.round(rect.x),Math.round(rect.y),Math.round(rect.width),Math.round(rect.height));

      selection_box[0]=rect.x;
      selection_box[1]=selection_box[0]+rect.width-1;
      selection_box[2]=visus1.osd.tileSources.height-(rect.y+rect.height);
      selection_box[3]=visus1.osd.tileSources.height-rect.y;
    }

    function callDownload(){
      if(!selection || selection.isSelecting==false){
        bounds=visus1.getBounds()
        rectToSelection(bounds)
        //console.log(selection_box)
        download(selection_box)
      }
      else{
        //console.log("rect", selection.rect)
        rectToSelection(selection.rect)
        download(selection_box)
        selection.toggleState()
      }
    }

    function updateDownloadResolution(value){
      sel_factor = 1
      sel_size = 0
      if(!selection || selection.isSelecting==false){
        bounds=visus1.getBounds()
        rectToSelection(bounds)
        //console.log(selection_box)
        sel_size = (selection_box[1]-selection_box[0])*(selection_box[3]-selection_box[2]);
        sel_factor=sel_size/(visus1.osd.tileSources.height*visus1.osd.tileSources.width)
      }
      else{
        //console.log("rect", selection.rect)
        rectToSelection(selection.rect)
        sel_size = (selection_box[1]-selection_box[0])*(selection_box[3]-selection_box[2]);
        sel_factor=sel_size/(visus1.osd.tileSources.height*visus1.osd.tileSources.width)
      }
      
      console.log("sel_factor", sel_factor)

      onResolutionChange(value, sel_factor)

      // Force max resolution to avoid crazy download requests
      var curr_size=parseFloat($('#size_est').text().substring(1,$('#size_est').text().length-2))
      console.log("curr "+curr_size)
      if(curr_size > 150.0) {
        $("#download_btn").prop("disabled", true);
        $("#download_alert").prop("hidden", false);
      }
      else{
        $("#download_btn").prop("disabled", false);
        $("#download_alert").prop("hidden", true);
      }

    }

   function copyClick() {
    
    var input = document.querySelector('#link_text');
    input.setSelectionRange(0, input.value.length + 1);
    input.select();
    try {
      var success = document.execCommand('copy');
      if (success) {
        document.getElementById('link_text').value = "The URL has been copied to your clipboard"
        // Change tooltip message to "Copied!"
        console.log("success copy")
      } else {
        // Handle error. Perhaps change tooltip message to tell user to use Ctrl-c
        // instead.
        console.log("not success copy")
      }
    } catch (err) {
      // Handle error. Perhaps change tooltip message to tell user to use Ctrl-c
      // instead.
      console.log("error copy", err)
    }
  };

  $('#downloadModal').onLoad = function (){
    updateDownloadResolution($('#edit_resolution').val);
  };

  var title=getUrlParameter('title');
  if(title)
    $("#titlelbl").html("<b>"+decodeURI(title)+"</b>");
  
  var dataname=getUrlParameter('dataset')
  console.log("DATASET: "+dataname)
  if (dataname.includes("VegIndices")){
    $('#field_controls').show();
    $('#colormap_controls').show();
    $('#range_controls').show();
  }
  else{
    $('#field_controls').hide();
    $('#colormap_controls').hide();
    $('#range_controls').hide();
  }

  </script>

</body>
</html>
